use std::collections::HashSet;
use std::hash::{Hash, Hasher};

use indoc::indoc;

#[derive(Debug, PartialEq, Eq, PartialOrd, Ord, Hash)]
struct Galaxy {
    row: usize,
    col: usize,
}

fn read_galaxies(input: &str) -> Vec<Galaxy> {
    input
        .lines()
        .enumerate()
        .map(|(row, line)| line
            .chars()
            .enumerate()
            .filter_map(move |(col, c)| if c == '#' { Some(Galaxy { row, col }) } else { None })
        )
        .flatten()
        .collect()
}

fn expand_galaxies(galaxies: &[Galaxy], amount: usize) -> Vec<Galaxy> {
    let mut nrows = 0;
    let mut occupied_rows = HashSet::new();

    let mut ncols = 0;
    let mut occupied_cols = HashSet::new();

    for g in galaxies {
        if g.row > nrows {
            nrows = g.row;
        }

        occupied_rows.insert(g.row);

        if g.col > ncols {
            ncols = g.col;
        }

        occupied_cols.insert(g.col);
    }

    let empty_rows = (0..=nrows)
        .filter(|row| !occupied_rows.contains(row))
        .collect::<HashSet<_>>();

    let empty_cols = (0..=ncols)
        .filter(|col| !occupied_cols.contains(col))
        .collect::<HashSet<_>>();
    
    galaxies
        .iter()
        .map(|g| Galaxy {
            col: g.col + empty_cols.iter().filter(|&&c| g.col > c).count() * amount,
            row: g.row + empty_rows.iter().filter(|&&r| g.row > r).count() * amount,
        })
        .collect()
}

#[derive(Debug, Eq)]
struct Pair<'a> {
    g1: &'a Galaxy,
    g2: &'a Galaxy,
}

impl<'a> Pair<'a> {
    fn first(&self) -> &'a Galaxy {
        self.g1.min(self.g2)
    }

    fn second(&self) -> &'a Galaxy {
        self.g1.max(self.g2)
    }

    fn distance(&self) -> usize {
        let col = if self.g1.col < self.g2.col {
            self.g2.col - self.g1.col
        } else {
            self.g1.col - self.g2.col
        };

        let row = if self.g1.row < self.g2.row {
            self.g2.row - self.g1.row
        } else {
            self.g1.row - self.g2.row
        };

        row + col
    }
}

impl<'a> PartialEq for Pair<'a> {
    fn eq(&self, other: &Self) -> bool {
        self.first() == other.first() && self.second() == other.second()
    }
}

impl<'a> Hash for Pair<'a> {
    fn hash<H: Hasher>(&self, state: &mut H) {
        self.first().hash(state);
        self.second().hash(state);
    }
}

fn galaxy_pairs<'a>(galaxies: &'a [Galaxy]) -> HashSet<Pair<'a>> {
    galaxies
        .iter()
        .enumerate()
        .map(|(n, g1)| galaxies
            .iter()
            .skip(n + 1)
            .map(|g2| Pair { g1, g2 })
        )
        .flatten()
        .collect()
}

fn main() {
    let input = indoc!{"
        .....................#......#...................#...............#........................................#..................................
        ...........................................................#.............................................................#..................
        .....................................................................#.........#......#...........#.............#...........................
        .....................................................#.......................................#..............................................
        ......#.................................#..........................................................................................#........
        ....................#.........#.............................................................................#...............................
        ..#.........................................................#.............................................................................#.
        ........................................................................................#...........#..................#....................
        ........#....................................#........................#.........................................................#...........
        ..............................................................................#................................#............................
        ..................................................#............#............................................................................
        .........................#......#........#................................................#..........................................#......
        ......#..............................................................................#...............#......................................
        ...................................................................#........................................................................
        ....................#...........................#............................................................#..............#.....#.........
        ..................................#....................#.........................................#......#..............................#....
        .#..........................................................................................................................................
        ........#.....#........................#...........#.............#.....................#....................................................
        ..........................#.................................#.....................#.........................................................
        .............................................................................................................................#.............#
        ...................................#......................................................#....................#............................
        .....................#...................#............#..................#.............................................#...........#........
        ..............................................................................................#.............................................
        ....#..........#...............#..........................................................................#.................................
        .............................................#..............................................................................................
        ...................................................................#..............#.................................#.......................
        ..................#........................................................#................................................................
        ..#.................................#...................#..............................#.........................................#.......#..
        ...............................................................#...............#.....................#..........#.........#.................
        .........#......................#.............................................................#.............................................
        ..............#...............................#.............................................................................................
        ........................................#.................................#............................................................#....
        ..............................................................................................................#......#......#...............
        .........................#..........#.............................................#........#................................................
        ....................................................................#.....................................#.................................
        ....#...............#........#...............................#........................#........................................#............
        ........................................................#...................................................................................
        ............................................#...........................#......................#.....#......................................
        .........................................................................................#.............................................#....
        ...........#....................#..................................#.................................................#...........#..........
        .#..........................................................................................................................................
        ................#........................#..........#.......................................................................................
        ........................#........................................................................................#..........................
        ........................................................................#.........#...................#...................#.................
        ........................................................#......................................................................#............
        .....#.....................................................................................#................................................
        ...............#...................................#.................#..............................................................#.......
        .........#..................#..................................#..................................................#.........................
        ......................................#.......#....................................#......................................................#.
        ..........................................................................................................#......................#..........
        ...#..............#.......................#.....................................................#...........................................
        ................................#...............................................#..........#................................................
        ..........................#......................#......................#...................................................................
        ..................................................................#................................#........................................
        ......................................................#.................................#.........................#...................#.....
        ..............#..........................#..................................................................................#...............
        ......#......................#.................................................................#...........#................................
        .............................................................................#..............................................................
        .......................#..........................#......................................................................#..........#.......
        .#.................................#................................................................#....................................#..
        ........#......#................................................#...............................................#...........................
        ..........................................................................#.....#.........................#...........#.....#...............
        ............................#..............#..........#....................................#................................................
        ............................................................................................................................................
        ............#..........#....................................................................................................................
        ............................................................#.......................#..............#........................................
        .....................................#...............................#...................................#..................................
        .........#.....................................................................#.....................................#...............#.....#
        #.............#.............................................................................................................................
        ......................................................#....................................#....................................#...........
        ...................................................................#............................................#...........................
        ............................................................................................................................................
        ....................#............................#................................................#......................................#..
        .............................#...................................................#..........................................................
        .........................................................................#...............#.................#................................
        .............#.........#.........#.....#......................#............................................................#................
        ............................................................................................................................................
        .............................................#..........#.....................#..................................#..........................
        ............................................................................................................................................
        ...................................#.............#................#.....#.....................................................#.............
        ....#.....................#..................................#..............................................................................
        ............................................................................................................................................
        #.....................................#...................................................................................#.................
        ...............................................#......................#.....#...................................#...........................
        .........#...................#.....................................................#.................#......................................
        .......................#...............................#........................................#..............................#............
        ...#.....................................#..................................................................#...............................
        ...................................................#......................................#...........................................#.....
        .................#..........................................................................................................................
        ...................................................................................................................#......#.................
        .................................#..............#.....#......................#.................#.........#..................................
        #....................................................................#........................................#...........................#.
        ............................................................................................................................................
        .........................#..................................................................................................................
        ...............................#.......................................................................................#....................
        ..........#...................................#..................#.....................#....................#...............................
        ............................................................................#.....#.........................................................
        ....#............#............................................................................#.......#..........#..........................
        ..................................................................................................................................#.........
        ...................................#...........................................#............................................................
        .............................#..........................#.................................#........#........................................
        ..............#....................................................#........................................#.............#...........#.....
        ...............................................#.............#.......................................................#......................
        ........#..............................................................#....................................................................
        .......................................................................................#........#...........................................
        ......................#........#.........................#..................#........................#......................#...............
        .#.........#.....#..............................................#........................................................................#..
        .....................................................#......................................................................................
        .........................................#...........................#..............................................#.......................
        .............................................................#................................................#................#............
        ......#.......................................#.......................................#...............#.....................................
        ....................#.......#............................#................#...........................................................#.....
        ...........#.....................................................................................................#..........................
        ..........................................................................................#..............#..................................
        ..................................................#..........................................................................#..............
        ...............#............................................#.....................................................................#.........
        ........................#...........................................#............................#..................#.......................
        ................................................................................#..............................#.......................#....
        ......................................#...................................#..............#..............#...................................
        ..#............................................#..............#...........................................................#.................
        .........#........................#...................#.....................................................................................
        .............................#..............................................................................................................
        ....................................................................................#.......................................................
        .........................#.............#............................................................#......#......#.........#......#........
        ...................#...........................................................................#...........................................#
        .......#...............................................#.....#........#..........#..........................................................
        ..............#....................#........................................................................................................
        ........................................................................................................#.................#...........#.....
        ..#...............................................................#.........#.......#.......................................................
        .........#......................#..........................#.....................................#............#.............................
        ...................#.................................#.................................................................#....................
        ....................................#.......................................................................................................
        ...........................#......................................................................................................#.........
        ............................................#.................#............#...................#.......#...................#................
        ............#.....................................#.........................................................................................
        ...........................................................................................................#......#.........................
        .....................................#..............................................#......#................................................
        .........................................................................#..............................................#...................
        #....................#........#...................................................................#.....................................#...
        .....#........................................#.........#........................#..........................................................
    "};

    let galaxies = read_galaxies(input);
    let expanded = expand_galaxies(&galaxies, 1);
    let part1: usize = galaxy_pairs(&expanded)
        .into_iter()
        .map(|p| p.distance())
        .sum();
    
    println!("Part 1: {}", part1);

    let expanded = expand_galaxies(&galaxies, 999_999);
    let part2: usize = galaxy_pairs(&expanded)
        .into_iter()
        .map(|p| p.distance())
        .sum();

    println!("Part 2: {}", part2);
}

#[cfg(test)]
mod tests {
    use indoc::indoc;

    use crate::galaxy_pairs;

    use super::{Galaxy, Pair, expand_galaxies, read_galaxies};

    fn initial() -> Vec<Galaxy> {
        let input = indoc!{"
            ...#......
            .......#..
            #.........
            ..........
            ......#...
            .#........
            .........#
            ..........
            .......#..
            #...#.....
        "};

        read_galaxies(input)
    }

    fn expanded() -> Vec<Galaxy> {
        let input = indoc!{"
            ....#........
            .........#...
            #............
            .............
            .............
            ........#....
            .#...........
            ............#
            .............
            .............
            .........#...
            #....#.......
        "};

        read_galaxies(input)
    }

    #[test]
    fn parsing() {
        let expected = vec![
            Galaxy { row: 0, col: 3 },
            Galaxy { row: 1, col: 7 },
            Galaxy { row: 2, col: 0 },
            Galaxy { row: 4, col: 6 },
            Galaxy { row: 5, col: 1 },
            Galaxy { row: 6, col: 9 },
            Galaxy { row: 8, col: 7 },
            Galaxy { row: 9, col: 0 },
            Galaxy { row: 9, col: 4 },
        ];

        assert_eq!(initial(), expected);
    }

    #[test]
    fn expansion() {
        let galaxies = initial();

        assert_eq!(expand_galaxies(&galaxies, 1), expanded());
    }

    #[test]
    fn pairs() {
        let galaxies = initial();
        let pairs = galaxy_pairs(&galaxies);

        assert_eq!(pairs.len(), 36);
    }

    #[test]
    fn distance() {
        let galaxies = expanded();
        let p1 = Pair { g1: &galaxies[0], g2: &galaxies[6] };
        let p2 = Pair { g1: &galaxies[2], g2: &galaxies[5] };
        let p3 = Pair { g1: &galaxies[7], g2: &galaxies[8] };
        let total_distance: usize = galaxy_pairs(&galaxies)
            .into_iter()
            .map(|p| p.distance())
            .sum();

        assert_eq!(p1.distance(), 15);
        assert_eq!(p2.distance(), 17);
        assert_eq!(p3.distance(), 5);
        assert_eq!(total_distance, 374);

        let galaxies = initial();
        let galaxies = expand_galaxies(&galaxies, 9);
        let total_distance: usize = galaxy_pairs(&galaxies)
            .into_iter()
            .map(|p| p.distance())
            .sum();

        assert_eq!(total_distance, 1030);

        let galaxies = initial();
        let galaxies = expand_galaxies(&galaxies, 99);
        let total_distance: usize = galaxy_pairs(&galaxies)
            .into_iter()
            .map(|p| p.distance())
            .sum();

        assert_eq!(total_distance, 8410);
    }
}
