#[derive(Debug, Clone, Copy, PartialEq, Eq)]
enum Spring {
    Damaged,
    Operational,
}

#[derive(Debug, Clone)]
struct Row {
    springs: Vec<Spring>,
}

struct Groups<'a> {
    inner: std::slice::Iter<'a, Spring>,
}

impl<'a> Iterator for Groups<'a> {
    type Item = usize;

    fn next(&mut self) -> Option<Self::Item> {
        // Skip all operational springs
        while let Some(Spring::Operational) = self.inner.next() {
        }

        let mut count = 0;

        // Count the number of damaged springs
        while let Some(Spring::Damaged) = self.inner.next() {
            count += 1;
        }

        // If the group size is zero, we are finished
        match count {
            0 => None,
            c => Some(c),
        }
    }
}

impl Row {
    fn groups(&self) -> Groups<'_> {
        Groups {
            inner: self.springs.iter(),
        }
    }

    fn is_valid(&self, expected_groups: &[usize]) -> bool {
        let mut groups: Vec<_> = self
            .groups()
            .collect();

        assert!(groups.len() <= expected_groups.len());

        if groups.len() == expected_groups.len() {
            return &groups == expected_groups;
        }

        let mut iter = groups
            .into_iter()
            .zip(expected_groups)
            .peekable();

        while let Some((group, expected_group)) = iter.next() {
            if iter.peek().is_none() {
                if &group > expected_group {
                    return false;
                }
            } else {
                if &group != expected_group {
                    return false;
                }
            }
        }

        true
    }
}

impl Row {
    fn new() -> Self {
        Self { springs: Vec::new() }
    }

    fn push(&mut self, spring: Spring) {
        self.springs.push(spring);
    }

    fn with_spring(mut self, spring: Spring) -> Self {
        self.springs.push(spring);
        self
    }

    fn group_sizes(&self) -> Vec<usize> {
        let mut sizes = Vec::new();
        let mut current_size: Option<usize> = None;

        for spring in &self.springs {
            match spring {
                Spring::Damaged => {
                    if let Some(size) = current_size.as_mut() {
                        *size += 1;
                    } else {
                        current_size = Some(1);
                    }
                },
                Spring::Operational => {
                    if let Some(size) = current_size.take() {
                        sizes.push(size);
                    }
                },
            }
        }

        if let Some(size) = current_size {
            sizes.push(size);
        }

        sizes
    }
}

struct Record {
    configurations: Vec<Row>,
    groups: Vec<usize>,
}

impl Record {
    fn n_valid_configurations(&self) -> usize {
        self.configurations
            .iter()
            .filter(|row| row.group_sizes() == self.groups)
            .count()
    }
}

impl<'a> From<&'a str> for Record {
    fn from(input: &'a str) -> Self {
        let (symbols, groups) = input.split_once(" ").unwrap();
        let mut configurations: Vec<Row> = vec![Row::new()];

        for c in symbols.chars() {
            match c {
                '.' => {
                    for row in &mut configurations {
                        row.push(Spring::Operational);
                    }
                },
                '#' => {
                    for row in &mut configurations {
                        row.push(Spring::Damaged);
                    }
                },
                '?' => {
                    let mut next_configurations = Vec::with_capacity(configurations.len());

                    for row in configurations {
                        next_configurations.push(row.clone().with_spring(Spring::Damaged));
                        next_configurations.push(row.with_spring(Spring::Operational));
                    }

                    configurations = next_configurations;
                },
                _ => unreachable!(),
            }
        }

        Self {
            configurations,
            groups: groups
                .split(",")
                .map(|s| s.parse().unwrap())
                .collect()
        }
    }
}

fn main() {
    let input = indoc::indoc!{"
        ..???.??.? 1,1,1
        ?#?##???.???? 2,5,1,1
        ?#??????##? 1,1,2
        ?#.#?#??#??? 1,7,1
        ?#???#?#??.#.###.? 3,1,3,1,3,1
        ?#......#.?.?. 1,1,1
        .????#????? 2,1,2
        #.?...?#????#??? 1,7,1
        ?.#??.??#? 2,1,1
        .#???###?#??#???#?.? 7,1,7
        ?###?.??#??..? 5,4
        .#?.??#????#?.?. 2,4,1,1
        #.#??????? 1,1,4
        #????##.???#???. 1,1,2,1,5
        ?.?.##???#???##.? 2,7
        ????.?#?.? 2,2
        ??.#?????#??#. 1,10
        ???????.???#?? 6,1,2
        #?.#???.?? 2,4,1
        ?####????.?.?? 4,3,2
        ?????#???? 6,1
        ????.???????#?#.? 1,5
        .#???##.?#??#??? 6,5
        ??#?#?????????????. 8,4,1
        ???.????#?#.???? 7,4
        ?#???#?.?????????? 2,1,8,1
        #?.#?#?.?? 1,3,2
        ?.??##??????.?. 1,5,1
        ????#????????#????.? 5,9
        ?.#?#????? 1,5
        ??????#.??.??.? 1,5,1,2
        ##?#??????#.#?#??? 5,1,2,6
        ????.?##?#..# 2,3,1,1
        ??.?..???.?#?#? 2,4
        ???##???.?#??#?# 1,5,6
        ??.????#?????#?? 1,9
        ??##?#????.#???.#??? 1,8,4,1,1
        ##?#???????. 4,1,3
        ?#???##?????#? 1,1,6,1
        ????????##?#?????? 1,14
        ????#????.??? 1,2,1,1
        ?##.???.#???.#?.??# 3,1,1,4,2,1
        ?##???????? 2,2,1
        ?????#??????.??# 1,5,1,1
        #?#?????????#.? 5,1,1,2,1
        .?.?.??.#. 1,1,1
        .?#.??#?#?????###?. 2,12
        ??.?????#???.???? 1,1,1,4,2
        ??????#?##?#?? 2,6
        ..????#?##???? 1,4,1
        .?#?#??.#???. 2,1,1,1
        .??????#?? 1,1,1
        ?#?.?#???#???#? 1,4,1,2
        ??????????#???##?. 1,1,10
        ???##????.??? 1,4,1,2
        .???#??.##???????##? 5,3,1,6
        ?#??#???.??? 1,1,1
        .??..?????#. 1,4,1
        ???#?????.. 1,3,1
        ?#???.?#???#?..#??# 2,1,5,1,2
        ?#??#?.???.#???. 1,3,1,2
        .#??#?.???#???#?? 1,1,9
        ?.?#?##...??? 1,4,1,1
        ??#?#?#??##???????. 3,3,3,1,3
        ???#?#?.??#? 6,3
        ?#?.#??##.#? 1,1,2,2
        ?????##??#??? 6,3,1
        ????##???? 1,2
        ???.???.???.?. 2,2,3
        ??#????????????# 5,1,1,3
        ????#?.?..????.??# 2,1,1,2,1,1
        .?##?##???? 3,4
        ?..??????#? 1,1,5
        ..?????#.?.##?#.?? 4,4
        #???.?????? 2,2
        ?.??#??????.? 1,4,2
        ?###??#???.?#?.?? 3,1,1,2,1
        ?????????.????????# 1,1,1,2,4
        ??#.??#?##.???.???? 1,1,6,3,1,1
        ???#.###????. 3,4,1
        ?#.?????????.?# 1,3,3,1
        #.???#.????????#?? 1,1,1,2,7
        ???#?.?????.#? 1,1,4,1
        ???#..???.? 3,3
        ?.????#####??#.?#?? 1,1,9,1,1
        ????#.?#???? 2,1,5
        .#?#..#??????????? 3,1,9
        ?.??..???? 2,1
        ???????#??.???????.? 1,1,4,1,1,2
        ..??.??????? 1,1
        ??.?????##?? 1,6
        ????????##??.????? 1,7,1,1,1
        ???.?###???? 1,5
        #.?###??#?#???????? 1,4,1,1,3,1
        ????.???????????? 2,1,7
        #?#??#????.?#????? 7,1,1,1
        ?##???#.?#???#?##??# 3,1,2,4,1
        ???#??#?????.?##? 7,3
        ?????????..??? 1,5,1
        .???#???.????#.? 5,1,1,1
        ?#?????#????? 2,3,1
        .???#???#???..??##. 5,1,4
        ?????.?##.# 5,2,1
        ??#????#?.# 5,2,1
        #?.????#???#????? 2,1,2,1,2
        ????????.??.?????? 7,5
        ..#?#??###.??????? 8,3
        #?.??.??##?.?#? 1,1,5,3
        .#????#?#?##?. 1,8
        ?#?????#.? 1,3
        .???.?..#? 1,1,1
        ??.??.????? 2,1
        ?#??????#??##?##... 1,11
        .#?????????? 1,1,3,1
        ??#????#?????#??#?? 8,5
        ?#??#???..##.?? 7,2,2
        ?.????.#??#?.?##?? 1,1,1,2,5
        .?.????????#??##??? 1,2,5,4
        ?.???##?.????#???## 5,3,4
        #..#?##?#?#?????? 1,8,4
        ?????##?.?#.?? 1,4,2,1
        ?????????. 4,1
        ???#??.???????#?. 5,5,1
        ?.???.?#????##???# 1,1,8,1,1
        ???????..????? 1,3,4
        ?#?##??#?????#?#???? 8,6
        ???#????#.??????..?. 5,3,6,1
        ?.??##???.??#? 6,2
        ??.??.???#????#??? 2,1,8
        ?????##????.#?. 1,1,7,1
        ??.??#??.?.##? 5,3
        ???.?#?#??..?? 1,5,1
        .#????##?????? 1,7,1
        .??????..#?. 1,1,1
        #?#??##.?.??. 7,1
        ?##?#???..?#.???# 4,1,2,1,1
        ???????#?? 3,3
        ?.????.#?#??##.??.? 1,1,4,2,1,1
        ?.?????##?.? 1,1,5,1
        .#???.?.?##.?.? 1,1,2,1,1
        #.??.?#?#? 1,1,3
        ?????.?#??#???# 1,1,8
        .??#?##??.??.# 1,6,1,1
        #??????#??#???#? 1,6,1,2
        .??..?#????#???#??? 2,3,7
        .??#.??##.?#?.#?#? 1,1,4,1,3
        ???.??#???.???. 2,1,1,2
        ?#?..???#??.? 1,2,3
        ?#??#.#????????.?.?? 1,1,6,1,1,2
        #??##?#????.?#???## 1,4,1,1,1,2
        .???#?????? 1,2,1
        ??.?.?##..??#?. 1,2,3
        ?.#?.#?#??#??#?? 2,3,6
        ?#??.#??.???????? 1,1,2,6
        ?#??.#???#???#.??.?? 4,1,6,1,1
        ##????#?.??????# 4,1,2,1
        ..?##????.. 3,3
        .??#?.???? 3,1
        ??..????#?.?? 1,2,2,2
        ?.????.???.#..#? 2,1,1,1,2
        ??#?##?#??##. 6,3
        ????????.?????.?.# 1,1,3,1,1,1
        .?#?###?#?????.???? 8,2,3
        .???##??#?.?? 5,3,1
        .?#??##??#.?# 9,1
        ?##???.??????? 3,1,1,2
        ?#?#?#?????????????? 6,1,1,1,1,1
        .??#??##???#????. 11,1
        ?#.#????##?? 2,1,1,4
        ?.?.?.??#?????.??# 1,1,8,1,1
        ?.??.?????.? 1,1,4,1
        ?.#???.##.????.??? 1,2,1,2,3,2
        .?.#??#??? 1,1,1
        ?.???????## 6,2
        ?.?.#?.##???.?. 1,2,2,1,1
        ???..?.??#???#????# 2,1,1,1,3,2
        ?????????.??#? 2,1,2
        .?.?#.#??#?????#??? 1,1,4,1,1,1
        ????#??.?#????#??? 4,4,2
        .????.?..?.??.?#.?. 1,2
        ??#?????#?#??.??#??? 1,1,8,4,1
        ?????????? 1,4
        ?.?#??.?#?????#? 2,3,4
        ???.##.??.??? 1,2,1,1
        .?.???????#.#.. 8,1
        #??.????###??????? 1,1,3,8
        ??#?#.#??..?? 3,2
        #..??.????#???.#?#?. 1,1,5,1,1,1
        ??.??.???#??.? 2,1,6,1
        .????##???? 1,7
        .?###?.??.? 4,1,1
        ?.?#??#?.#..??#??? 6,1,1,1,1
        .??????.?# 4,1
        ##????.?????.?? 6,2,1,1
        .?????#.?? 1,3,1
        ?.????#??#?????? 6,3,1
        .????#?.#?.?????#?# 6,2,6,1
        .?.???#????###???##? 4,10
        ?..?#????? 4,1
        .??#??.?##.?.#?#?#? 3,3,1,1,1,2
        ..??#.??????.? 3,1
        ??????????#?????.. 1,6,1
        ??#????#?????###?? 7,6
        ???..#???? 1,1,1
        ..#?#??...???#?.? 1,1,1,4,1
        ..#..????#???####. 1,10
        ?#??????.??? 1,2,1,1
        ??????.#???. 5,4
        ??#?#.????? 4,1,2
        ?#??.??.??#.? 1,1,2,2
        #???.??#??#?.?#??##? 1,1,1,5,7
        ???.??#?.?#?? 1,4,1
        .??????#???#????#?. 3,5,6
        ???????#?? 2,2
        #??#?#?###?..??#???? 1,4,4,1,3
        ?##??????#?##???? 4,2,7
        ???????..?.#???? 5,1,1,4
        ?????????#???#??? 1,1,1,7,2
        ?.##.???????#???. 2,6,1,1
        .?##?#?.?#?..?. 5,3
        .????.?.?. 2,1
        ??#??#?.????.??..? 5,2,2,1
        ????##?#???. 1,3,1,1
        #?.??##?###.??#? 1,1,6,1,2
        ?.?.?#?.#?.? 1,3,1,1
        ?????????##???##???. 2,2,3,6
        #????????.???##.? 4,4,5
        ???????..???? 5,1,3
        ??.????##????###??? 2,1,5,5,1
        ??...??#????#???. 2,8,1
        ???#??????? 1,3,2
        ????.??..?.?? 2,1
        .???.#?????. 1,6
        ??#?????#.??.#?? 3,1,1,1,1
        ##?.???##????????? 2,4,1,2,1
        ???###??##?.?.?.???? 9,2
        ???#????.? 1,6
        ??#???#?..#.#?? 5,2,1,3
        .??#????????#? 8,1
        ?.?#??#????#??? 1,5,1,2
        ???..?.????#???#.? 1,1,1,3,1,1
        ????##???.#?#?. 4,4
        ??#?.#???? 3,2
        ?.#??#???#????? 1,6,1,1,1
        ??????#?#??#?.???? 1,1,7,1,1
        ?.?????.?. 2,1,1
        .??##?.?#???? 2,2
        .#??#??#?????.??#.? 1,5,2,2
        ?.??#?.???# 3,1,2
        ?..???????? 1,5
        #?????????#?#??.?#. 2,1,2,7,2
        ?.?????##.?#??# 1,2,2,2,1
        ?????.??##. 2,4
        ??##??#??.?#?????. 1,6,6
        ???###???? 5,1
        ###???#???.????????. 4,1,1,1,2,1
        ??.???#.?#?. 2,3,1
        ?#?.??#?.?#????#?? 1,2,1,3
        ?????????#?? 1,7
        ??????????????????.? 1,5,4,4,1
        ?#.?.???#?? 1,5
        ?###?????#??? 5,2,3
        ?.???#???#??????. 1,1,4,2,1
        ?????#??####.##??#? 6,4,2,3
        ???.#???.???#???? 4,4
        ??#?.#?###????? 1,6,2
        ??????#?#?#???.????? 2,8,3,1
        .?????.???????????? 1,4,3
        ?????.?##???? 4,3
        ???#???.??#??? 4,1,4
        #?????.?.#. 3,1,1
        .?##???##?#??????. 2,1,4,1,1,1
        ??????#?.????. 6,3
        ?.???#?#?#??.#??# 2,1,5,1,1
        ???##?##?.?.??#.? 8,3
        ???#???????..?? 1,1,1,2,1
        ??#???#.??#??..??? 7,1,3,1
        ????#?.?.#.?? 5,1,1,1
        #??##.?#????#???? 1,2,1,5,1
        ???#.????..?##?? 4,1,2,1
        ???#?????.??.????# 5,1,1,1,2
        ????.?.??#?????#? 1,1,1,1,8
        ???#???#??## 2,5,2
        #.????#?.?#????????? 1,5,1,1,1,1
        ##?#?#?.?? 6,1
        .#?#??????#????.?? 1,2,3,2,1
        ?#?????.#?? 7,2
        ???#????.?. 1,4
        ?.#.?.???.##.## 1,1,2,2,2
        ???????.?.??#??#.? 2,4
        ????.???.#?? 2,2,1,1
        .??#?#?????#?#??#? 5,3,4,2
        ##?????????.?????? 6,2,2,2
        ???#???????? 1,1,2,1
        ???????????..??#? 2,1,1,1,3
        ?????.??.???? 5,1,3
        ?????????..?# 1,2,2,1
        ??????????.?#..?? 3,4,2
        ???#?#?????#..????? 9,3
        ??????.?#??#???#? 1,4,1,6
        ??#?#????.??? 5,1
        ???#.?#?????##. 3,9
        ?????#???.????#? 2,1,4,1,3
        .??#???..???? 6,3
        ?#.?#..??. 1,2,2
        .????????.? 1,2,1
        ??.?#??.???? 1,2,1,1
        .?..#?.??.?.??? 1,1,2,1,1
        ???#?#????###???? 2,1,3,4,2
        ????..??## 1,2,4
        ????????..???#????#? 1,3,1,9
        ??#????.##?..??? 5,2,2
        ???????##.???#?. 3,5,3
        ?#???.???????? 4,8
        ???????#???..#?.? 4,5,2,1
        ???.??##????.#??.? 1,8,1,1,1
        ??.?###???.??#.?? 1,6,1,1,1
        ???.##??#?#? 3,7
        .??.???????????? 1,6,5
        ?#?#?.??.??.??? 5,1,1,1
        ?????#????#???#??#. 5,2,5
        ??#?#?.??#??#??????# 4,13
        #??#????.???## 8,1,2
        ????.????. 2,2
        #??#???#?????#? 4,3,3
        #?????#.#?.? 2,2,1
        #???.??.#.#? 3,1,1,1
        ???????#?.?#??## 2,2,5
        ???##?.#???????#. 2,3,4,3
        ?#??.???.#. 3,2,1
        #?##?.?????.#?#?# 5,2,1,5
        ???#????#.?????? 4,1,1,2,1
        #.?.?##?#?#???#? 1,11
        ?.??.?#??##?? 1,7
        ?????#..#?.##?#????? 1,2,1,4,3
        #????.?##????##??# 1,1,4,5
        ?#????.???##? 3,5
        ?#?.??????? 3,1,1
        .#.???#...#??. 1,3,3
        ?#?...???#? 2,1,1
        ??.#??.???..? 1,3,1,1
        .?????.#?? 5,1
        #?????#.##?#?????? 2,4,7,1
        ?.????.??#??#??#??.. 3,1,1,6
        ??????????? 2,7
        ?.????..?#?# 2,4
        ?????#..?#????# 1,1,1,3,2
        ??.#????###???????#? 9,4
        ?#??.##?.??.??????? 2,3,1,2,2
        .#?##.?#??# 1,2,5
        ??###?#?#??????.?#? 1,8,2,1,2
        ?#.###???#??????? 2,11,1
        ?.?.????#??#?# 1,1,1,3
        ?????.??#???#? 3,2,2
        ?#..???.??##???#?? 2,2,3,1,1
        ??#?#..?#???? 3,1
        ?????????.? 2,1,1
        ??#?#?.?#?. 5,2
        #????#?????#.??. 8,1,1,1
        #???#?#???.##..?#. 8,2,1
        .#.?#?##??.?..??.?#? 1,5,1,1,1,3
        ???#????.???.# 5,1,1,1
        ?#??..???#. 3,3
        ????#?????#..??#? 1,2,5,1,1
        ..???????##???? 3,5,1
        ??#?##.???#??? 5,3
        ??#?????????##?##?? 5,5,2
        .#???????? 7,1
        ?.?.#.?#???????? 1,1,1,5,1
        ??##...??#?. 3,3
        .??????#??? 2,1,1
        #??.??????.? 3,1,1
        ..?..?..?????#? 1,3
        ??#.???????#??? 2,1,6,1
        ???#??.??. 3,1
        .##???...#????##? 5,7
        ??###????.?????? 8,4
        ??##??..??.?# 6,1,2
        ?????#.??# 1,1,1
        ??#?????.?#??????? 4,1,1,4,2
        ??##??..??? 6,2
        ##?##??#?????#??#.# 11,1,2,1
        .?##?#.?#. 5,1
        ?????#??????##? 1,11
        ????#????????####? 2,1,6
        .?.?#???????? 6,1
        ???#?#????.??#?? 5,1
        #??#.???##?????#? 1,1,6,1,3
        .??.?#???????# 1,4,1,2
        ??????#???..??#?#?? 4,5
        ?????.?..????##?#. 2,8
        ?????.#.?#?? 4,1,3
        ?????#???.??.??# 1,1,2,1,3
        ?#??????.??#???#??? 1,1,2,4,4
        .???#?#???. 1,1,3
        ????.??###??? 1,1,3,1
        .?#????#?##?#.? 2,5,1
        ..?.????.?.??#??? 1,3
        ???##?????.. 3,1
        ##???????????#?? 8,2,1,1
        ????###?????##?..? 1,1,6,4,1
        .?????????#??#??#?? 10,2,2
        ?#.??????? 1,1,1
        #.????????## 1,1,1,2
        ??#?.??????#.?.???? 3,2,1,1,1,1
        ?#?.#??#??????.????? 2,7,1,4
        ?##??#????##?#?.##?? 2,3,3,2,4
        #..#?.??#??#?? 1,1,6,1
        #.???..???????? 1,1,1,4,3
        ?##????.?? 2,1,1
        .?#??..##????..?? 2,6,2
        ..#?.##???. 2,4
        #?.???#.?? 1,2,2
        ???##??????.??. 1,5,1,1
        ?#???#??#.????? 9,1
        ????#.???? 5,1,1
        #??????.#???#???# 1,2,1,7,1
        #?????##??#????.???? 3,8,1,1
        ?.#????##?#??.?..?? 1,2,8,1,2
        #???????.??#? 1,2,4
        ??###??.?.? 6,1
        .??????#.??? 1,1,1,3
        .??#??###???#?..?#.. 9,1,1
        ?.?.??##?# 1,6
        ????#?????# 1,2,3
        ??##??????##??# 11,2
        ?#?????#?? 1,2,1
        #.#??.???#.##????#? 1,2,2,1,8
        ?#.??#?????? 1,3,1,1
        ..???????.? 3,2
        #??.?.???????? 3,1,1,1
        ??##???#???# 8,1
        #????.?#??#????#.. 1,1,1,1,3,1
        ?####?#???.?.? 8,1
        ..#.???#??.. 1,4
        .??.?#??????#???? 1,9,2
        ?#?.?????? 3,4
        #??.#?????????? 2,2,3,3
        ??#????.???. 5,1,1,1
        .??#???#.??#?. 3,1,3
        .?#??#.#?.?#?.# 2,1,1,2,1
        ??????????.?????. 8,2
        ?.???.??.?? 1,1
        #?.?????##..###? 1,1,4,4
        ?.#??.????.##? 2,3,2
        ????#????? 1,2,2
        ?###?.#???? 4,2
        .?.?.????.?.#?? 1,1,1,1,3
        .??#???.???#??##???. 4,5
        ..??#??#..##?#. 4,2,1
        ?##???##??.??????.?? 8,2,2
        #??#?????#?#. 1,5,1,1
        ???.?????#??. 1,1,4
        ..???##??#??.?? 7,1
        ??.#.?????.??????#? 1,1,1,2,1,2
        ?#.#?.#????##??##? 2,1,1,1,2,2
        ?##?.?..##???? 3,1,4
        ????..?#??#.? 3,5
        .#?##???.?#.. 6,1
        ?.?.???..#????? 1,1,1,2,1
        ?.#???#????#?#?### 1,12
        ??.?#?#..?#??.???? 3,3,1
        ???#?##?## 1,7
        #???????.#.#..#? 6,1,1,1
        ????????.????#?? 2,2,1,1,3
        ?????.?#?#?#?????## 2,2,5,1,3
        ??????#.???? 1,4,1,1
        ?????#??.##?. 1,2,3
        ?????#???.???.? 1,6,1
        ?#??.??#????#??##? 3,11
        ??#?.#??#???? 2,4
        ..??#????.??? 2,1,1,1
        ??????#?#??..? 2,3,1
        ?#?#??.??###????? 4,5,1
        ???#??##?#??.?.??#? 1,1,6,1,1,1
        ##?.#.?.#??#.#? 3,1,1,2,1
        ?##??.?.?????#? 3,2,3
        ?##?#???##???#.#?#? 12,1,1,1
        ???#?#?.?#???. 4,3
        .????##??. 2,2
        ??#???#??#?????????. 1,8,3,1,2
        ?#????#... 2,3
        ??.??#???? 1,3,1
        ?#?.????????#? 1,3,1,1
        ?..??#?.#.????? 4,1,1,2
        ?????.????#?????.?. 5,7,1,1
        ??.?#?.?##???#??#? 2,2,8,1
        ?????.#??#??#?????? 1,1,2,1,7
        ??.?????.#? 1,4,1
        ?#?#???..##?? 5,3
        ?.?.??????. 1,2,1
        ?#?#.?#?#???????.# 2,1,7,1,1
        ??????????????#???? 2,1,1,9
        #?.???.??. 1,1,1
        #?.?????#??.##?#? 1,1,4,5
        ?.????#??.? 3,1
        ???#??##????##??.?. 1,1,11,1
        ??#????????#? 1,4,1,1
        ???#...?.? 2,1
        ?#????##??#????. 1,1,2,5
        ?.?.#???????.#?.??. 4,2
        .???.#?#?????#???#? 1,1,8,3
        ?.??.?.?.??# 1,1,1,3
        #?..#?.?#? 2,1,1
        ?.????.#??#? 1,1,1,2
        ?#???????? 2,2,1
        .?????.???.??????.. 3,1,1
        .?#?.##?##. 1,5
        ??#????...?##. 6,2
        ??..#??#??????????. 1,14
        #?.#?????##.#???.#.? 1,8,1,1,1,1
        #????##???.????.?? 1,1,6,1,1,1
        ????#.???? 5,1
        ?##?#???####?#?? 4,1,7
        ?.?????.?#??.#? 1,4,2,1
        ??#?.?????. 2,1,1
        ???.?#???? 1,3
        ##?????#?#?.#??#?# 2,1,4,1,1,1
        ?#????.#??##.#?? 3,1,5,1
        .?#.?#.#?.?? 2,1,2,2
        ??.????.#? 1,2,1
        ??..????#.?? 2,1,1
        ??.?.?#?#.???? 1,1,3,2
        ?#??.????#? 3,6
        ?????#????###?? 3,4
        ?##??.#????????#??? 4,1,4,1,2,1
        ??##?#??????????. 1,11,2
        #?.??????#??#?#??##? 1,15
        #?..???##?.#? 1,1,2,1
        ?.?????#??#???.? 1,6,1
        ?##??????#?.? 6,2
        ..?###??..?.????. 5,4
        ???#??..?.#. 3,1,1
        ??#??#???###.?#?? 12,2
        ?.?#..?#.? 1,2
        ##??#?????? 2,1,1
        #?#?.#??#?.?# 4,4,1
        ???#??#.?? 1,2,1
        ?#?.??.???# 2,1,2
        ?#??#??#???.?.?#??? 10,2
        ?????.##?#???? 1,2,5,2
        ?.?.?#??????##. 1,3,4
        .#??..????#..#.??? 1,2,2,1,1,1
        .?..?#?..????? 3,1
        ??????????.??. 7,2
        ??.?#?###.??? 1,5,1
        .???#??.??#??. 2,1,5
        ?#???????.??#? 2,2,4
        #?#????.???#?? 5,2
        ?#??#???????#?.#?? 1,1,4,1,1,1
        #?#??##..?#????#??. 7,1,3
        ?##???.#?. 2,2,1
        .??.????#??#???? 1,7,1
        ?#?.??##?..??? 2,4,2
        ..?#??.??. 2,1
        ??????????????.???. 4,2
        #.?#?#????#???#?.?? 1,1,11,1
        ??#??.#?..#?#. 1,2,1,3
        .??????#?#?#??. 2,1,1,1,1
        ?.???.???##???? 2,1,4
        ??.??????.. 3,1
        .?#?????#?#??..? 1,6
        .?#?????????? 3,3
        .??..#??.???? 1,3,2
        ??#?###??#??. 2,8
        ?.??##???#??#?.?? 1,5,6,1
        ????????#?? 2,1,4
        ??###?????? 4,2
        ?.###?????#???#. 3,2,1,3
        #????#????? 1,4,2
        ????...??????#???.?? 1,2,1,1,6,1
        ??????#??#?.?.???# 1,1,7,1,3
        ??#.??#??? 2,5
        .?##???#????##???#? 4,2,2,2
        ?#??#.??.???#?????#? 4,1,1,2,1,2
        ??.??????????.? 1,1,1,2,1
        ??.????#.????#? 1,1,6
        ??#??#?????? 7,2
        ???.??????#??????? 3,2,4
        #?#?#?#?????.???? 1,1,8,1,1
        ???????#?????##????. 1,9
        ??.??.???##??.????.# 2,2,5,2,1
        ???#....#? 2,1
        ??##?.??????#.. 1,2,1,1,1
        #?????##?#????#?. 5,5,1
        ???.#.????.???????? 2,1,1,1,3,1
        #????.#????.????. 1,1,4,4
        ?????###???#??.#? 3,4,2,1
        ??.??#??????? 2,1,1
        ???..#???# 1,1,1
        ???????????????? 2,1,1,2,1
        ???##?????? 2,1
        ??????##????#???? 7,1,1,1
        #?#?..???#?##? 4,5
        #.????#?.????#.?? 1,2,1,5
        .???.?????...?#?.?? 1,2
        ?#?.?#????????.???## 2,4,3,5
        .??#.#????#?#????#?? 3,2,9,1
        ??####.???#?##?? 5,1,2,4
        ??????????#?#?#?? 1,1,1,2,3
        ?#?#?????###???##.. 4,2,8
        ???#??.?????#?? 1,2,1,4
        ?.???##???. 1,3,1
        ?#?#????#???#? 1,6,4
        ?.?#?.?????#??? 3,4
        ???##??#?## 1,2,4
        ?#?????????.?? 5,1
        .??##????#?#?????? 2,6,1,1
        ?#??#??##. 1,5
        ?.????.??#?. 1,1,1,1
        ???#???.??#???#??#? 4,10
        #???#?#.????????#? 7,1,1,1
        #????#?#?? 4,3
        ???.??.?????? 1,2,3
        ??.#.??????##??? 1,1,1,1,6
        ??????.???? 4,1
        ?.?#??.#??. 3,1
        ?.##???#????#??????? 3,1,1,3,2
        .?????#????.??#?.?. 3,1,3,1,1,1
        ?#??#??????#? 1,3,5
        ???#?.?.?. 5,1,1
        ##..??#??##?? 2,8
        ?????#????# 2,3
        ?#.???###?????.. 1,7
        ?###???#??##??# 8,5
        ??.?.?#????? 1,1,2,2
        ?#?.??.?#? 3,1
        ????????.????#?#.?# 1,2,1,6,1
        ??##...????.????#?. 3,1,5
        ????..???.?..? 3,1,1
        .#???.###?#?? 2,3,2
        ?##?#??????.?...# 4,2,1,1,1
        ???#?????#.? 1,4
        ??.??#??..????. 1,3,1,4
        .##?..??.?#?? 2,1,3
        ???##.?.?.?????#?? 1,2,1,3,2
        ??#??#?.?????????. 5,2,5
        #??????#.??#?? 1,2,1,3
        .??#???????? 7,2
        .#?#?.??#.? 3,2
        ????##?##??..???. 9,2
        .????.???#? 3,4
        ?.??#??###?#?#?. 9,2
        ???#???.?? 2,1
        .?.??????? 1,2,2
        ??????????.#? 1,5,1
        ?????#?.???#??.??? 1,4
        ??#??.##.?? 3,2,1
        ???#???#??#?#????? 3,2,5,1,1
        ?#???????.. 4,2
        .?????#????.?#?? 5,3
        ?..????##????????? 6,4
        ?????#?.?.??.#?? 3,3
        ???#???.#?#?.?#??? 1,2,1,1,2,3
        #????.??#??. 4,1,3
        ???#??????#???##? 4,9
        ??.?..#?.????.. 2,1
        #??#.??.#????#? 1,1,2,7
        ???.?#.?..?.?? 2,2,1,2
        ?.?#?##??.#.#?.?#. 1,5,1,1,1,2
        ?#?#??##???#???? 11,1
        .????..#???##? 2,1,1,2
        #??.??##?.?.??#??#? 3,4,1,3,3
        ##??.?#?.###? 2,2,3
        ?#???????????### 1,1,1,1,3
        .?#?##???##??????? 4,4,1
        ?.????????#????? 2,2,6
        ?#??.?..######?# 2,1,8
        ???.??.???##..???#? 1,2,1,2,1,2
        ...##??.#?.?? 4,1,1
        ?.#?..??.? 2,2
        ?##??..?##???? 4,2,3
        ???#?#??????.?#??? 8,4
        ?#.?????##.??#? 1,2,4,2
        ???#.#???##?.# 3,2,2,1
        ?????????????..?.? 1,6
        #???????.?# 4,2,1
        ???????#??? 2,1,3
        .???.######?.? 1,6
        ??.??????. 2,1,1
        ?#????.????#?#.?.??# 3,7,3
        ??#??.????? 3,2
        ???#?????????????#?? 10,6
        .?.????.???. 1,2,1,1
        ??.????#.?#?? 1,2,1,2
        .?.???..?# 1,1,1
        ?#?...?##??? 2,2
        ##??##??#?.?.??. 10,1
        ??#??????????.?.??? 12,1,1
        ?????#?#???#????.?# 1,11,1
        ?.???.?.??? 2,3
        ??..?#?#??#???#?? 1,2,9
        .#???..??## 3,1,2
        ?##?#??.?.????????. 6,1,1,1,1
        ??????#?????#??.?? 1,13,1
        #?..????.#???#?? 2,1,6
        .???#??..#? 4,2
        ????..?#?? 1,2
        .??#????????.#.?? 8,1,1,1
        #??.??.?#. 2,1,2
        ??#.?.??????##?? 1,1,4,3,1
        ??.??.?#?.?????#?? 2,1,1,2,3
        ?#????????#?.?#. 10,1
        ??.????????? 1,5,2
        ?????.?.???#???.?.?? 2,6
        .?####?#?#???#??? 8,3,1
        ?????##.?#????.??.? 1,4,2,2,1,1
        .?????????#??????#? 3,10
        .??.????## 1,2,2
        ?.##.?.??##?.? 2,5
        ?????#???? 7,1
        .?#...?.#. 1,1,1
        .???##.???#.?.##?. 5,1,3
        ?.?????..?..# 1,2,1,1
        ??#??????#?? 4,4
        ?????#??.?. 4,1
        ???#?.?#?#??.? 2,1,5,1
        ??????.????. 1,1,1,2
        .?.???#.#?????#?? 1,3,1,2,3
        ????#??????#??.??#? 12,1
        ??...?..??????#.?? 1,1,6,1
        .?.??.???.?#?? 1,2,3
        ?.????#?????#?##??? 1,13
        ?.???#?##???.#..??? 1,1,1,4,1,1
        ?.#?##???#??#.?? 1,9,1,1
        ??#?.?#??#.? 1,5
        ??.#?????..????#???? 1,1,3,8
        ???#?#?#???#?.??# 1,10,2
        .????##??? 1,5
        ???#??..?.? 6,1,1
        ?.?.????????#???? 1,1,3,1,5
        ????????#?..?????? 5,2,6
        ?????????#????#.?# 2,5,1,2
        .???????#??#?? 2,6
        #??..?##.?? 3,2
        ?????????#?#??#?#. 2,5,4
        ?#??.?.?#??? 4,1
        ###?????##.?.#?#... 10,3
        ???#?##?.???#?#????? 2,5,2,1,3
        ??#?.??.??#.##???#.. 4,1,1,1,4,1
        ??#???.??????.? 3,1,2,1,1
        ??#???#.??##????? 1,2,2,7
        .?#??.????##??#?.?? 3,7
        ?.???.???? 1,1,3
        ?????.???????????### 1,1,1,1,1,5
        ?.?.?????#?..??#?#? 1,1,1,1,1,6
        ?.#.?.?????#?#?#?#?# 1,14
        ?..##???#??#??#????? 1,4,12
        ??????#?#?. 6,1
        #??..??###??.??#???. 3,5,4
        ??##.?##.??????.? 3,2,1,1
        ??#????.??.????? 1,2,1,1,2
        #?#????????.??????? 5,2,5
        ???????.????? 2,1,1,1
        ????.????###???? 2,6
        #??##?##????.. 9,1
        #??#.##??? 1,1,3
        ###?.?##?.? 3,4,1
        ??#???##?#?????# 2,11
        .?#.??.??.? 1,2,1
        ??????#????.? 2,6
        ???##?#???.?#??#? 4,1,4
        ....???#?..##?..??? 5,2,2
        ?..?..?????.##?###?? 1,1,4,6,1
        #??????????? 2,1,1,4
        ??#?????.?????#??.? 5,2,4
        .?????.????? 1,1,3
        ?#?.?????#????#?#??? 3,2,1,5
        .?#??????.? 3,1
        #???.??.??.# 4,1,1,1
        ?.#?.????????.??? 1,2,2,1,2
        ??.?#?##??????.. 5,1
        ??####????.?#?.?? 7,2
        .?###??????????## 5,2,1,2
        #??.?????.???#? 2,2,1,2
        ????????#??.??#? 1,1,3,3
        .?????????????# 3,7
        ###?#?.??? 3,2,1
        ?#?##??..#?#?? 5,1,1
        .#?.?#...??# 2,2,3
        .#???#?????#??. 1,1,6
        ??##????????? 5,4
        .??##??.????.?? 5,1
        ???#?#.#??###?#?.# 1,1,1,1,5,1
        ?????#????? 3,1
        .?????.?#.? 1,1,2
        ??????..?.?? 1,2,1,1
        ????#.???????????.? 1,7
        ??#??????##??#. 3,2,5
        ???????.???#??.???. 5,1,1,1,1,2
        ?#?????#?##.???#??.? 1,5,2,1,4,1
        .???#..???????? 4,1,3
        ?????.???. 2,1,1
        ??#??.##??.? 2,2,1,1
        .??#???????...??#??? 10,1,1,1
        .##??#???????..????. 5,2,1
        .?#?.?.???#? 2,3
        ???????.???#?? 1,2,5
        ???.??????.????#??? 3,3
        ??????????????#.? 1,1,1,5,1
        ???????.#?? 4,2
        #?????#????????.? 1,1,8,1
        ###??#????? 6,1
        ???????????#?..???# 3,5,3
        ??#####??????.?? 6,3,1
        ?.????.??.?? 3,1
        .##??#????#..??... 2,7,1
        ??#?#?????.#. 4,1,1
        #?????##?#??..???? 2,1,6,1,2
        ??###????????? 7,1
        ???.??.#?#.?????? 3,2,3,2,2
        ?#?????#?????? 2,8
        ???????#?#? 1,2,3
        ?#?#??.?#.??##???? 4,1,1,1,5
        ??????#??# 1,5
        ?#?..??#??. 1,4
        ???????????. 4,1
        .?##?#????????#??.. 4,8
        ???.????...????.. 2,2
        ??????.#..??? 1,2,1,1
        ?????????? 1,3
        ???#?.??????.? 4,1,1,1
        ?.???????#. 1,1,2
        ??.??????.????#?? 2,1,1,2,5
        .???#??????.#??. 9,2
        ?#?#?.??.????. 2,2,2
        .?.?????.? 1,2
        #????#?#???.???.? 1,3,1,3
        ..#?##???????#??.??# 6,1,3,1,1,1
        ?.?..#?????.???????. 2,5
        ?.?.???.???? 1,2
        ?.#???.?..?.#?? 1,3,1,1,2
        ?.??#???.????? 1,4,1,2
        #??.??.??# 3,2,1
        ????#???????#? 5,3
        ?#?.?#??.?????? 2,3,4
        ##???.??????? 5,1,1,1
        ??..?##?????????. 5,1
        .??????.#??#.##...# 4,1,4,2,1
        ?.???#???.???. 1,4,2
        ##?#???????.?????##? 6,3,1,4
        ???.??.#?#? 2,1,3
        ???.?.##..?????? 2,1,2,4
        #????#??##??.?#? 2,1,4,2
        #????#?????.???.. 1,1,2,2,2
        ???#?.??.????? 1,3,5
        ?????##??????????# 1,6,1,1,1
        ?#?#???.#???????.. 4,8
        ???#??#???..?#?. 2,5,3
        ?.???#.?.??????? 2,2
        .?#?#???#???#?#?? 4,9
        .?#?..#?##????.???.. 2,4,1,1,1,1
        ???#..?.?? 4,1
        .#??.?#???#??.???? 1,8,2
        .?????#??##?#???? 2,2,2,1,1
        ???.?#?.?. 2,2
        ?##??#??.??.##??#??. 6,7
        .#.??????#?????#?# 1,1,3,3,5
        .?.?????????????##? 1,3,1,7
        ??.??????#?##??? 1,1,3,3,1
        ?????.##?#? 1,1,5
        .##.??#?.??.?? 2,2,1,1
        ??#..#??#?..#??? 3,5,1,1
        ??#????????#?????? 13,2
        ?#????..?.??? 2,1,1
        ?????#?.#????. 4,2
        .?##?.?..? 4,1
        ?##?#??#?##??#?? 12,2
        #?##?.???????#?#?#? 1,2,1,8,2
        ?.?.##?.????#??# 1,2,1,1,4
        ????.???#?.? 1,1,2
        ..????##???????#???? 7,5
        ??????#??????? 1,8,2
        ?#?????????. 1,1,5
        ??#?##???????????.? 8,1,3
        #.??##???###??. 1,10,1
        .????#??#?#???.???# 12,4
        ??.?#????#?.???.. 1,7,1,1
        ???#####?????.##?? 7,1,3
        ?.?????.#?#?.?. 1,5,3,1
        ..??..##?????. 2,2,2
        ??????????#? 1,1,1,1
        #?#??.??##??#..? 4,2,1
        #?.????.???.? 1,4,3,1
        ?????#????##?#?### 1,1,1,1,8
        ?.??##??.?#.? 6,1
        #???????.????? 4,1,3,1
        #???#???#??..?#..??? 3,1,1,3,2,1
        #??.???????#????? 3,9
        ??#?##????#??????.? 5,8
        #???????#???.?#???#? 1,1,5,2,3
        .#???#????###.??. 1,8,1
        ?#???#?##?##???##?#? 2,12,1
        #.?.#???#.? 1,1,2
        ?.??#?#.???#?????.?? 3,3
        ???#.??.??#??#??? 1,5
        ?????#???? 2,3,1
        ????.?#??#?????????. 2,1,5,2,4
        .?????.#???##?#.?.? 2,1,6,1,1,1
        ?..#?.??...?#? 1,1,1
        ?#.??????? 1,1,1
        ??###..?#? 4,2
        ????##.?#.#???????? 1,2,1,5,2
        #??.?###?##???.?? 1,1,6,1,1
        ???#?????...???.??? 4,2
        ?.?.??.??#????.? 1,1,5,1
        ??#?.?????.?????? 2,1,1,1,4
        ?.?.???.?#?#???? 1,1,2,3,1
        ??##?..??#??.?.. 2,1,1
        .??.??.???? 1,2,2
        ?#.??##????#.???? 1,3,3,2
        ??#?#??????#?# 5,7
        ??#.??#.#?#???. 2,1,1,6
        ??#????.??. 5,1
        ????#??.???##?#?#? 6,8
        #???#??#?? 2,1,1
        ??.???#???#? 1,5
        .#...??.????.?# 1,2,1,1,1
        ##.????#?.#..?#? 2,4,1,2
        ????#???#?.?.?#??? 9,1
        ?#.???#??#??????#? 1,4,1,1,1,1
        ??????.??.?????#..? 2,4
        ??.?###?.???#??##??? 4,5
        ?#..##???#?#?? 2,10
        ..??????#?.?##?. 1,4,3
        ?????????? 2,5
        ????.?????????#?##?. 1,1,2,2,2,5
        .?????#?.#?????? 1,3,4,2
        ??.????#?. 1,4
        ?#?#..#.#??##????? 3,1,6,1
        ?..?.??.??????? 1,2,6
        .#??#?#?????## 2,3,6
        ?#?..???...???##.? 1,3,5,1
        ?###??????##?#?..??? 3,3,6,2
        ?????#.?#???. 1,2,1,4
        ???????.??#???? 1,1,1,5
        .???.??..?#???.?? 2,3
        #.??.#?????..???# 1,1,3,1,4
        ?.??.?????????. 1,1,2,6
        ?#.#???..?.?#?? 2,1,1,1,2
        ????????#??.??#????? 1,1,4,1,6
        .#????#?#.? 3,1,1
        ?#??#.????.#?.. 1,1,2,1,1
        ?????##??.?????? 2,6,1,2
        #.??.???.???????. 1,2,1,1,4
        ??##?#?#??..??? 7,3
        ?#???.??.?. 4,2,1
        ?????#?????.# 5,1,1
        ?#?.??#?.?#? 1,3,3
        ?.??.???#?#???. 1,5
        ??##.?#???.???.#. 3,4,2,1
        .???..??.??. 3,1,1
        #?..?.??#?.? 2,3,1
        ##???#.?#?.#?? 6,1,2
        ?#.??.?#.? 2,1,1
        ???????????? 1,1,1,1
        ?..#???#??#?#?.?# 1,2,3,4,1
        ?##?#??????????##. 11,3
        #?#??..?.#?????#???# 1,1,1,1,11
        ??.?##?#??.??#???? 1,6,5,1
        ??.?#?#..?.?. 4,1
        ##?..????.?#.?#? 3,1,2,2,2
        ???#.???#? 1,1,2
        ??#?????#?#?#???#? 13,1
        ??#?...??.#?.?#?? 1,2,1,2
        ?.??.????#.????.??. 1,1,1,1,4,1
        ??.?????.#? 1,5,1
        ??.#?????#.. 1,4,1
        ?..#??????.?? 2,1
        ??#???#?.#?? 6,2
        ???????#?.#?? 3,1,2,3
        ?#?#??##.?#???#??? 8,1,5
        ??##?????.????? 5,1,1,1
        ???..??.?##. 1,1,1,3
        ?.?#?..#.?#? 3,1,3
        .???????#??#? 7,1
        .#.????#?#?#?. 1,3,3,2
        ??#.#..????????#??#. 3,1,8,1
        #??????#.??? 1,1,1,1
        ?#?????#???? 2,1,1,1
        #?????#??#??#.?#??? 1,7,1,1,1
        ???#.???.???.?? 3,2,1,2
        ??#?.???#####?##?? 1,1,1,10
        ??#?????.#??? 6,1,2
        ????#????#?.?? 2,4,2
        ????????#? 1,1,5
        ???#???.?#.?? 4,2,1
        ?#??..???#?#??????#? 4,1,5,4
        ?#?.?#?#???##?#? 1,4,4,1
        ???#.?.#?????# 3,1,1,1
        ???.?#?.????? 2,1,5
        .?????#?#??##.?????? 9,3
        ??#???#.???? 7,1
        ????#?####.?#? 6,2
        ?.?????????#??.# 1,1,2,6,1
        ?????.?.???#???? 4,1,4,2
        #?.?.??#?#??? 1,1,3,1
        ??#?.?????#??? 4,1,5
        ?.?????.##..??? 1,2,1
        ???###?#??.???.? 7,1
    "};

    let records: Vec<_> = input
        .lines()
        .map(Record::from)
        .collect();

    let part1: usize = records
        .iter()
        .map(|r| r.n_valid_configurations())
        .sum();

    println!("Part 1: {}", part1);
}

#[cfg(test)]
mod tests {
    use super::{Record, Row};

    #[test]
    fn row_groups() {
        use super::Spring::{Damaged as D, Operational as O};

        let tests = [
            (Row { springs: vec![D, O, D, O, D, D, D] }, vec![1, 1, 3]),
            (Row { springs: vec![O, D, O, O, O, D, O, O, O, O, D, D, D, O] }, vec![1, 1, 3]),
            (Row { springs: vec![O, D, O, D, D, D, O, D, O, D, D, D, D, D, D] }, vec![1, 3, 1, 6]),
        ];

        for (n, (row, expected)) in tests.into_iter().enumerate() {
            assert_eq!(row.group_sizes(), expected, "Row {} failed", n + 1)
        }
    }

    #[test]
    fn parse_record() {
        let tests = [
            ("#.#.### 1,1,3", 7, 1, vec![1, 1, 3], 1),
            (".??..??...?##. 1,1,3", 14, 32, vec![1, 1, 3], 4),
        ];

        for (input, n_springs, n_configurations, groups, n_valid) in tests {
            let record = Record::from(input);
            
            assert!(record.configurations.iter().all(|row| row.springs.len() == n_springs));
            assert_eq!(record.configurations.len(), n_configurations);
            assert_eq!(record.groups, groups);
            assert_eq!(record.n_valid_configurations(), n_valid);
        }
    }
}
